#!/bin/bash
# Textile ERP - Docker Deployment Script
# This script automates Docker setup and deployment

set -e

# Colors for output
RED='\033[0;31m'\nGREEN='\033[0;32m'\nYELLOW='\033[1;33m'\nBLUE='\033[0;34m'\nNC='\033[0m' # No Color\n\n# Functions\necho_info() {\n    echo -e \"${BLUE}ℹ️  $1${NC}\"\n}\n\necho_success() {\n    echo -e \"${GREEN}✅ $1${NC}\"\n}\n\necho_warning() {\n    echo -e \"${YELLOW}⚠️  $1${NC}\"\n}\n\necho_error() {\n    echo -e \"${RED}❌ $1${NC}\"\n}\n\n# Header\nclear\necho_info \"╔════════════════════════════════════════════════════════════╗\"\necho_info \"║     TEXTILE ERP - DOCKER DEPLOYMENT AUTOMATION            ║\"\necho_info \"╚════════════════════════════════════════════════════════════╝\"\necho \"\"\n\n# Check Docker installation\necho_info \"Checking Docker installation...\"\nif ! command -v docker &> /dev/null; then\n    echo_error \"Docker is not installed. Please install Docker first.\"\n    exit 1\nfi\necho_success \"Docker found: $(docker --version)\"\n\nif ! command -v docker-compose &> /dev/null; then\n    echo_error \"Docker Compose is not installed. Please install Docker Compose first.\"\n    exit 1\nfi\necho_success \"Docker Compose found: $(docker-compose --version)\"\n\n# Menu\necho \"\"\necho_info \"Select operation:\"\necho \"  1) Setup and Start (Development)\"\necho \"  2) Start Existing Services\"\necho \"  3) Stop Services\"\necho \"  4) View Logs\"\necho \"  5) View Status\"\necho \"  6) Restart Services\"\necho \"  7) Clean Up (Remove containers and volumes)\"\necho \"  8) Production Setup\"\necho \"\"\nread -p \"Enter choice (1-8): \" choice\n\ncase $choice in\n    1)\n        echo \"\"\n        echo_info \"Starting Development Setup...\"\n        \n        # Create .env if not exists\n        if [ ! -f .env ]; then\n            echo_warning \"Creating .env file from .env.docker template\"\n            cp .env.docker .env\n            echo_success \".env file created. Update if needed.\"\n        fi\n        \n        echo_info \"Building images and starting services...\"\n        docker-compose build\n        docker-compose up -d\n        \n        echo \"\"\n        echo_success \"Services started successfully!\"\n        echo \"\"\n        echo_info \"Access points:\"\n        echo \"  • Backend API: http://localhost:8000\"\n        echo \"  • API Docs: http://localhost:8000/docs\"\n        echo \"  • PgAdmin: http://localhost:5050\"\n        echo \"  • Frontend: http://localhost\"\n        echo \"\"\n        echo_info \"Waiting for services to be healthy...\"\n        sleep 5\n        docker-compose ps\n        ;;\n    2)\n        echo \"\"\n        echo_info \"Starting existing services...\"\n        docker-compose start\n        echo_success \"Services started!\"\n        docker-compose ps\n        ;;\n    3)\n        echo \"\"\n        echo_info \"Stopping services...\"\n        docker-compose stop\n        echo_success \"Services stopped!\"\n        ;;\n    4)\n        echo \"\"\n        echo_info \"Showing logs (Press Ctrl+C to exit)...\"\n        docker-compose logs -f\n        ;;\n    5)\n        echo \"\"\n        echo_info \"Service Status:\"\n        docker-compose ps\n        ;;\n    6)\n        echo \"\"\n        echo_info \"Restarting services...\"\n        docker-compose restart\n        echo_success \"Services restarted!\"\n        docker-compose ps\n        ;;\n    7)\n        echo \"\"\n        echo_warning \"This will remove all containers and volumes!\"\n        read -p \"Are you sure? (yes/no): \" confirm\n        if [ \"$confirm\" = \"yes\" ]; then\n            echo_info \"Cleaning up...\"\n            docker-compose down -v\n            echo_success \"Cleanup complete!\"\n        else\n            echo_info \"Cleanup cancelled.\"\n        fi\n        ;;\n    8)\n        echo \"\"\n        echo_info \"Setting up for Production...\"\n        echo_warning \"This requires additional configuration.\"\n        \n        # Create production .env\n        if [ ! -f .env.prod ]; then\n            echo_info \"Creating production .env file...\"\n            cp .env.docker .env.prod\n            echo_warning \"Please update .env.prod with production values:\"\n            echo \"  1. POSTGRES_PASSWORD - Use strong password\"\n            echo \"  2. SECRET_KEY - Generate new secure key\"\n            echo \"  3. CORS_ORIGINS - Set your domain\"\n            echo \"  4. DEBUG - Set to False\"\n        fi\n        \n        echo_info \"Starting production setup...\"\n        echo \"docker-compose --env-file .env.prod up -d\"\n        read -p \"Run the above command? (yes/no): \" confirm\n        if [ \"$confirm\" = \"yes\" ]; then\n            docker-compose --env-file .env.prod up -d\n            echo_success \"Production deployment started!\"\n            docker-compose ps\n        fi\n        ;;\n    *)\n        echo_error \"Invalid choice. Please run the script again.\"\n        exit 1\n        ;;\nesac\n\necho \"\"\necho_success \"Operation complete!\"\necho_info \"For more information, see DOCKER_DEPLOYMENT.md\"\n"
