<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Purchase Order - Textile ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <nav class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <i class="fas fa-industry text-2xl"></i>
                <h1 class="text-2xl font-bold">Textile ERP</h1>
            </div>
            <div class="flex items-center space-x-6">
                <a href="../dashboard.html" class="hover:text-indigo-200">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="supplier-list.html" class="hover:text-indigo-200">
                    <i class="fas fa-arrow-left"></i> Back to Suppliers
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-5xl mx-auto">
            <!-- Page Header -->
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Create Purchase Order</h2>
                <p class="text-gray-600">Create a new purchase order for materials</p>
            </div>

            <form id="createPOForm" onsubmit="submitPurchaseOrder(event)" class="space-y-6">
                <!-- PO Header -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4">Purchase Order Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Supplier *</label>
                            <select id="supplierSelect" name="supplier_id" required 
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Supplier...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Order Date *</label>
                            <input type="date" name="order_date" required 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Expected Delivery Date</label>
                            <input type="date" name="expected_delivery_date" 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Terms</label>
                            <input type="text" name="payment_terms" placeholder="e.g., Net 30" 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea name="notes" rows="3" 
                                      class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- PO Items -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Order Items</h3>
                        <button type="button" onclick="addPOItem()" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>

                    <div id="poItemsContainer">
                        <!-- Items will be added here -->
                    </div>

                    <!-- Summary -->
                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-end">
                            <div class="w-64">
                                <div class="flex justify-between mb-2">
                                    <span class="font-medium">Subtotal:</span>
                                    <span id="subtotal" class="font-bold">$0.00</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="font-medium">Tax (0%):</span>
                                    <span id="tax" class="font-bold">$0.00</span>
                                </div>
                                <div class="flex justify-between text-lg border-t pt-2">
                                    <span class="font-bold">Total:</span>
                                    <span id="total" class="font-bold text-indigo-600">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4">
                    <a href="supplier-list.html" 
                       class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Cancel
                    </a>
                    <button type="submit" 
                            class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-save"></i> Create Purchase Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let itemCounter = 0;
        let materials = [];

        function getToken() {
            return localStorage.getItem('token') || '';
        }

        // Load suppliers
        async function loadSuppliers() {
            try {
                const response = await fetch(`${API_BASE}/procurement/suppliers?limit=100`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const suppliers = await response.json();
                
                const select = document.getElementById('supplierSelect');
                suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.supplier_id;
                    option.textContent = `${supplier.supplier_code} - ${supplier.name}`;
                    select.appendChild(option);
                });

                // Check for supplier_id in URL
                const params = new URLSearchParams(window.location.search);
                const supplierId = params.get('supplier_id');
                if (supplierId) {
                    select.value = supplierId;
                }
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        }

        // Load materials
        async function loadMaterials() {
            try {
                const response = await fetch(`${API_BASE}/inventory/materials?limit=100`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                materials = await response.json();
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        }

        // Add PO item row
        function addPOItem() {
            const container = document.getElementById('poItemsContainer');
            const itemId = itemCounter++;
            
            const itemDiv = document.createElement('div');
            itemDiv.id = `item-${itemId}`;
            itemDiv.className = 'grid grid-cols-12 gap-3 mb-3 items-end';
            itemDiv.innerHTML = `
                <div class="col-span-5">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                    <select name="items[${itemId}][material_id]" required 
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select Material...</option>
                        ${materials.map(m => `<option value="${m.material_id}">${m.material_code} - ${m.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" name="items[${itemId}][quantity]" step="0.01" required 
                           onchange="calculateTotal()"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                    <input type="number" name="items[${itemId}][unit_price]" step="0.01" required 
                           onchange="calculateTotal()"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Total</label>
                    <input type="text" id="item-total-${itemId}" readonly 
                           class="w-full px-3 py-2 border rounded-lg bg-gray-50" value="$0.00">
                </div>
                <div class="col-span-1">
                    <button type="button" onclick="removePOItem(${itemId})" 
                            class="w-full px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(itemDiv);
        }

        // Remove PO item
        function removePOItem(itemId) {
            document.getElementById(`item-${itemId}`).remove();
            calculateTotal();
        }

        // Calculate totals
        function calculateTotal() {
            let subtotal = 0;
            
            document.querySelectorAll('[name^="items"]').forEach((input) => {
                if (input.name.includes('[quantity]')) {
                    const itemId = input.name.match(/\[(\d+)\]/)[1];
                    const quantity = parseFloat(input.value) || 0;
                    const priceInput = document.querySelector(`[name="items[${itemId}][unit_price]"]`);
                    const price = parseFloat(priceInput?.value) || 0;
                    const itemTotal = quantity * price;
                    
                    const totalInput = document.getElementById(`item-total-${itemId}`);
                    if (totalInput) {
                        totalInput.value = `$${itemTotal.toFixed(2)}`;
                    }
                    
                    subtotal += itemTotal;
                }
            });
            
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax').textContent = '$0.00';
            document.getElementById('total').textContent = `$${subtotal.toFixed(2)}`;
        }

        // Submit purchase order
        async function submitPurchaseOrder(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            
            // Build items array
            const items = [];
            document.querySelectorAll('[name^="items"]').forEach((input) => {
                if (input.name.includes('[material_id]')) {
                    const itemId = input.name.match(/\[(\d+)\]/)[1];
                    const quantityInput = document.querySelector(`[name="items[${itemId}][quantity]"]`);
                    const priceInput = document.querySelector(`[name="items[${itemId}][unit_price]"]`);
                    
                    items.push({
                        material_id: parseInt(input.value),
                        quantity: parseFloat(quantityInput.value),
                        unit_price: parseFloat(priceInput.value)
                    });
                }
            });

            if (items.length === 0) {
                alert('Please add at least one item to the purchase order');
                return;
            }

            const data = {
                supplier_id: parseInt(formData.get('supplier_id')),
                order_date: formData.get('order_date'),
                expected_delivery_date: formData.get('expected_delivery_date') || null,
                notes: formData.get('notes') || null,
                items: items
            };

            try {
                const response = await fetch(`${API_BASE}/procurement/purchase-orders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to create purchase order');

                const result = await response.json();
                alert(`Purchase Order ${result.po_number} created successfully!`);
                window.location.href = 'supplier-list.html';
            } catch (error) {
                console.error('Error creating purchase order:', error);
                alert('Error creating purchase order. Please try again.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Set today's date
            document.querySelector('[name="order_date"]').valueAsDate = new Date();
            
            await loadSuppliers();
            await loadMaterials();
            addPOItem(); // Add first item row
        });
    </script>
</body>
</html>
