<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Dashboard - Textile ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <nav class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <i class="fas fa-industry text-2xl"></i>
                <h1 class="text-2xl font-bold">Textile ERP</h1>
            </div>
            <div class="flex items-center space-x-6">
                <a href="../dashboard.html" class="hover:text-indigo-200">
                    <i class="fas fa-home"></i> Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Page Header -->
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Inventory Stock Dashboard</h2>
            <p class="text-gray-600">Real-time stock levels and inventory management</p>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Materials</p>
                        <p id="total-materials" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <i class="fas fa-boxes text-4xl text-blue-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Stock Value</p>
                        <p id="total-value" class="text-3xl font-bold text-green-600">$0</p>
                    </div>
                    <i class="fas fa-dollar-sign text-4xl text-green-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Low Stock Items</p>
                        <p id="low-stock-count" class="text-3xl font-bold text-orange-600">0</p>
                    </div>
                    <i class="fas fa-exclamation-triangle text-4xl text-orange-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Reorder Alerts</p>
                        <p id="reorder-alerts" class="text-3xl font-bold text-red-600">0</p>
                    </div>
                    <i class="fas fa-bell text-4xl text-red-500"></i>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4">Stock by Category</h3>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4">Stock Value by Category</h3>
                <canvas id="valueChart"></canvas>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <input type="text" id="searchInput" placeholder="Material name or code..." 
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="categoryFilter" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Categories</option>
                        <option value="raw_material">Raw Material</option>
                        <option value="finished_goods">Finished Goods</option>
                        <option value="work_in_progress">Work in Progress</option>
                        <option value="consumable">Consumable</option>
                        <option value="spare_parts">Spare Parts</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Stock Status</label>
                    <select id="stockFilter" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Stock</option>
                        <option value="low">Low Stock</option>
                        <option value="normal">Normal Stock</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="applyFilters()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition w-full">
                        <i class="fas fa-filter"></i> Apply
                    </button>
                </div>
                <div class="flex items-end">
                    <button onclick="openReceiveModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition w-full">
                        <i class="fas fa-plus"></i> Receive Stock
                    </button>
                </div>
            </div>
        </div>

        <!-- Stock Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Material</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Cost</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reorder Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="10" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl"></i>
                            <p class="mt-2">Loading stock data...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Receive Stock Modal -->
    <div id="receiveModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Receive Stock</h3>
                <button onclick="closeReceiveModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="receiveForm" onsubmit="submitReceive(event)">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Material *</label>
                        <select id="materialSelect" name="material_id" required 
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select Material...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
                        <input type="number" name="quantity" step="0.01" required 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Unit Cost *</label>
                        <input type="number" name="unit_cost" step="0.01" required 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <input type="text" name="location" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Warehouse</label>
                        <input type="text" name="warehouse" 
                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Supplier</label>
                        <select name="supplier_id" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select Supplier...</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea name="notes" rows="3" 
                                  class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeReceiveModal()" 
                            class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-check"></i> Receive Stock
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let categoryChart, valueChart;

        function getToken() {
            return localStorage.getItem('token') || '';
        }

        // Load stock data
        async function loadStock() {
            try {
                const response = await fetch(`${API_BASE}/inventory/stock`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const stock = await response.json();
                
                displayStock(stock);
                updateKPIs(stock);
                updateCharts(stock);
            } catch (error) {
                console.error('Error loading stock:', error);
            }
        }

        // Display stock in table
        function displayStock(stock) {
            const tbody = document.getElementById('stockTableBody');
            
            if (stock.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">No stock data available</td></tr>`;
                return;
            }

            tbody.innerHTML = stock.map(item => {
                const stockPercentage = item.reorder_level > 0 ? (item.total_quantity / item.reorder_level) * 100 : 100;
                const statusClass = item.is_low_stock ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                const statusText = item.is_low_stock ? 'Low Stock' : 'Normal';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${item.material_code}</td>
                        <td class="px-6 py-4 text-sm">${item.material_name}</td>
                        <td class="px-6 py-4 text-sm">${item.category.replace('_', ' ')}</td>
                        <td class="px-6 py-4 text-sm font-bold">${item.total_quantity.toFixed(2)}</td>
                        <td class="px-6 py-4 text-sm">${item.unit}</td>
                        <td class="px-6 py-4 text-sm">$${item.avg_unit_cost.toFixed(2)}</td>
                        <td class="px-6 py-4 text-sm font-bold text-green-600">$${item.total_value.toFixed(2)}</td>
                        <td class="px-6 py-4 text-sm">${item.reorder_level}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <button onclick="issueStock(${item.material_id})" class="text-orange-600 hover:text-orange-900 mr-2">
                                <i class="fas fa-minus-circle"></i> Issue
                            </button>
                            <button onclick="viewMovements(${item.material_id})" class="text-blue-600 hover:text-blue-900">
                                <i class="fas fa-history"></i> History
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update KPIs
        function updateKPIs(stock) {
            document.getElementById('total-materials').textContent = stock.length;
            
            const totalValue = stock.reduce((sum, item) => sum + parseFloat(item.total_value), 0);
            document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
            
            const lowStockCount = stock.filter(item => item.is_low_stock).length;
            document.getElementById('low-stock-count').textContent = lowStockCount;
            
            // Load reorder alerts
            loadReorderAlerts();
        }

        // Load reorder alerts
        async function loadReorderAlerts() {
            try {
                const response = await fetch(`${API_BASE}/inventory/reorder-alerts`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const alerts = await response.json();
                document.getElementById('reorder-alerts').textContent = alerts.length;
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        // Update charts
        function updateCharts(stock) {
            // Group by category
            const categoryData = stock.reduce((acc, item) => {
                const cat = item.category.replace('_', ' ');
                acc[cat] = (acc[cat] || 0) + parseFloat(item.total_quantity);
                return acc;
            }, {});

            const categoryValues = stock.reduce((acc, item) => {
                const cat = item.category.replace('_', ' ');
                acc[cat] = (acc[cat] || 0) + parseFloat(item.total_value);
                return acc;
            }, {});

            // Category quantity chart
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            // Category value chart
            if (valueChart) valueChart.destroy();
            valueChart = new Chart(document.getElementById('valueChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryValues),
                    datasets: [{
                        label: 'Stock Value ($)',
                        data: Object.values(categoryValues),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Load materials for dropdown
        async function loadMaterials() {
            try {
                const response = await fetch(`${API_BASE}/inventory/materials?limit=100`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const materials = await response.json();
                
                const select = document.getElementById('materialSelect');
                materials.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material.material_id;
                    option.textContent = `${material.material_code} - ${material.name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        }

        // Submit receive stock
        async function submitReceive(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // Convert to proper types
            data.material_id = parseInt(data.material_id);
            data.quantity = parseFloat(data.quantity);
            data.unit_cost = parseFloat(data.unit_cost);
            if (data.supplier_id) data.supplier_id = parseInt(data.supplier_id);

            try {
                const response = await fetch(`${API_BASE}/inventory/stock/receive`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to receive stock');

                alert('Stock received successfully!');
                closeReceiveModal();
                loadStock();
            } catch (error) {
                console.error('Error receiving stock:', error);
                alert('Error receiving stock. Please try again.');
            }
        }

        // Modal controls
        function openReceiveModal() {
            document.getElementById('receiveModal').classList.remove('hidden');
        }

        function closeReceiveModal() {
            document.getElementById('receiveModal').classList.add('hidden');
            document.getElementById('receiveForm').reset();
        }

        // Placeholder functions
        function applyFilters() {
            alert('Filter functionality coming soon');
        }

        function issueStock(materialId) {
            alert(`Issue stock for material ${materialId} - Issue form coming soon`);
        }

        function viewMovements(materialId) {
            alert(`View movements for material ${materialId} - Movement history coming soon`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadMaterials();
            await loadStock();
        });
    </script>
</body>
</html>
