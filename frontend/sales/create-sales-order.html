<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Sales Order - Textile ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <nav class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <i class="fas fa-industry text-2xl"></i>
                <h1 class="text-2xl font-bold">Textile ERP</h1>
            </div>
            <div class="flex items-center space-x-6">
                <a href="../dashboard.html" class="hover:text-indigo-200">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="sales-orders.html" class="hover:text-indigo-200">
                    <i class="fas fa-arrow-left"></i> Back to Sales Orders
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-5xl mx-auto">
            <!-- Page Header -->
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Create Sales Order</h2>
                <p class="text-gray-600">Create a new customer sales order</p>
            </div>

            <form id="createSOForm" onsubmit="submitSalesOrder(event)" class="space-y-6">
                <!-- Sales Order Header -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4">Order Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Customer *</label>
                            <select id="customerSelect" name="customer_id" required onchange="loadCustomerInfo()"
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Customer...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Order Date *</label>
                            <input type="date" name="order_date" required 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Date</label>
                            <input type="date" name="delivery_date" 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Customer PO Number</label>
                            <input type="text" name="customer_po_number" 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Shipping Address</label>
                            <textarea name="shipping_address" rows="2" 
                                      class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Billing Address</label>
                            <textarea name="billing_address" rows="2" 
                                      class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea name="notes" rows="2" 
                                      class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Order Items</h3>
                        <button type="button" onclick="addOrderItem()" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>

                    <div id="itemsContainer">
                        <!-- Items will be added here -->
                    </div>

                    <!-- Summary -->
                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-end">
                            <div class="w-64">
                                <div class="flex justify-between mb-2">
                                    <span class="font-medium">Subtotal:</span>
                                    <span id="subtotal" class="font-bold">$0.00</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="font-medium">Tax:</span>
                                    <input type="number" id="taxAmount" step="0.01" value="0" onchange="calculateTotal()"
                                           class="w-24 px-2 py-1 border rounded text-right">
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="font-medium">Discount:</span>
                                    <input type="number" id="discountAmount" step="0.01" value="0" onchange="calculateTotal()"
                                           class="w-24 px-2 py-1 border rounded text-right">
                                </div>
                                <div class="flex justify-between text-lg border-t pt-2">
                                    <span class="font-bold">Total:</span>
                                    <span id="total" class="font-bold text-indigo-600">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4">
                    <a href="sales-orders.html" 
                       class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Cancel
                    </a>
                    <button type="submit" 
                            class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-save"></i> Create Sales Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let itemCounter = 0;
        let products = [];
        let customers = [];

        function getToken() {
            return localStorage.getItem('token') || '';
        }

        async function loadCustomers() {
            try {
                const response = await fetch(`${API_BASE}/sales/customers?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                customers = await response.json();
                
                const select = document.getElementById('customerSelect');
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.customer_id;
                    option.textContent = `${customer.customer_code} - ${customer.name}`;
                    select.appendChild(option);
                });

                // Check for customer_id in URL
                const params = new URLSearchParams(window.location.search);
                const customerId = params.get('customer_id');
                if (customerId) {
                    select.value = customerId;
                    loadCustomerInfo();
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function loadCustomerInfo() {
            const customerId = document.getElementById('customerSelect').value;
            if (!customerId) return;

            const customer = customers.find(c => c.customer_id == customerId);
            if (customer) {
                // Pre-fill addresses if available
                const shippingAddr = document.querySelector('[name="shipping_address"]');
                const billingAddr = document.querySelector('[name="billing_address"]');
                
                if (customer.address && !shippingAddr.value) {
                    shippingAddr.value = customer.address;
                    billingAddr.value = customer.address;
                }
            }
        }

        async function loadProducts() {
            try {
                // Load products - you might want to filter by finished goods
                const response = await fetch(`${API_BASE}/inventory/materials?category=finished_goods&limit=1000`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const materials = await response.json();
                
                // Also try to load from production/products endpoint if exists
                try {
                    const prodResponse = await fetch(`${API_BASE}/production/work-orders?limit=1`, {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const wos = await response.json();
                    // Extract products from work orders if needed
                } catch (e) {
                    console.log('Using materials as products');
                }
                
                products = materials;
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function addOrderItem() {
            const container = document.getElementById('itemsContainer');
            const itemId = itemCounter++;
            
            const itemDiv = document.createElement('div');
            itemDiv.id = `item-${itemId}`;
            itemDiv.className = 'grid grid-cols-12 gap-3 mb-3 items-end';
            itemDiv.innerHTML = `
                <div class="col-span-5">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                    <select name="items[${itemId}][product_id]" required 
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select Product...</option>
                        ${products.map(p => `<option value="${p.material_id}">${p.material_code} - ${p.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" name="items[${itemId}][quantity]" step="0.01" required 
                           onchange="calculateTotal()"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                    <input type="number" name="items[${itemId}][unit_price]" step="0.01" required 
                           onchange="calculateTotal()"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Total</label>
                    <input type="text" id="item-total-${itemId}" readonly 
                           class="w-full px-3 py-2 border rounded-lg bg-gray-50" value="$0.00">
                </div>
                <div class="col-span-1">
                    <button type="button" onclick="removeOrderItem(${itemId})" 
                            class="w-full px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(itemDiv);
        }

        function removeOrderItem(itemId) {
            document.getElementById(`item-${itemId}`).remove();
            calculateTotal();
        }

        function calculateTotal() {
            let subtotal = 0;
            
            document.querySelectorAll('[name^="items"]').forEach((input) => {
                if (input.name.includes('[quantity]')) {
                    const itemId = input.name.match(/\[(\d+)\]/)[1];
                    const quantity = parseFloat(input.value) || 0;
                    const priceInput = document.querySelector(`[name="items[${itemId}][unit_price]"]`);
                    const price = parseFloat(priceInput?.value) || 0;
                    const itemTotal = quantity * price;
                    
                    const totalInput = document.getElementById(`item-total-${itemId}`);
                    if (totalInput) {
                        totalInput.value = `$${itemTotal.toFixed(2)}`;
                    }
                    
                    subtotal += itemTotal;
                }
            });
            
            const tax = parseFloat(document.getElementById('taxAmount').value) || 0;
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            const total = subtotal + tax - discount;
            
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }

        async function submitSalesOrder(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            
            // Build items array
            const items = [];
            document.querySelectorAll('[name^="items"]').forEach((input) => {
                if (input.name.includes('[product_id]')) {
                    const itemId = input.name.match(/\[(\d+)\]/)[1];
                    const quantityInput = document.querySelector(`[name="items[${itemId}][quantity]"]`);
                    const priceInput = document.querySelector(`[name="items[${itemId}][unit_price]"]`);
                    
                    items.push({
                        product_id: parseInt(input.value),
                        quantity: parseFloat(quantityInput.value),
                        unit_price: parseFloat(priceInput.value)
                    });
                }
            });

            if (items.length === 0) {
                alert('Please add at least one item to the sales order');
                return;
            }

            const tax = parseFloat(document.getElementById('taxAmount').value) || 0;
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;

            const data = {
                customer_id: parseInt(formData.get('customer_id')),
                order_date: formData.get('order_date'),
                delivery_date: formData.get('delivery_date') || null,
                customer_po_number: formData.get('customer_po_number') || null,
                shipping_address: formData.get('shipping_address') || null,
                billing_address: formData.get('billing_address') || null,
                notes: formData.get('notes') || null,
                tax_amount: tax,
                discount_amount: discount,
                items: items
            };

            try {
                const response = await fetch(`${API_BASE}/sales/sales-orders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create sales order');
                }

                const result = await response.json();
                alert(`Sales Order ${result.so_number} created successfully!`);
                window.location.href = 'sales-orders.html';
            } catch (error) {
                console.error('Error creating sales order:', error);
                alert(`Error: ${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Set today's date
            document.querySelector('[name="order_date"]').valueAsDate = new Date();
            
            await loadCustomers();
            await loadProducts();
            addOrderItem(); // Add first item row
        });
    </script>
</body>
</html>
