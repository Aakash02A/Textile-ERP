<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Control - Textile ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/modules/quality/styles.css">
</head>
<body class="bg-gray-50">
    <nav class="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 z-40 shadow-sm">
        <div class="flex items-center justify-between px-4 md:px-6 py-3">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-purple-600 to-pink-500 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold">TE</span>
                </div>
                <h1 class="text-lg md:text-xl font-bold text-gray-900">Textile ERP</h1>
            </div>
            <a href="/frontend/index.html" class="text-blue-600 hover:text-blue-700 font-medium">‚Üê Back</a>
        </div>
    </nav>

    <div class="pt-20 pb-8">
        <div class="max-w-7xl mx-auto px-4 md:px-6">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Quality Control</h2>
                <p class="text-gray-600 mt-2">Monitor and manage quality checks</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm font-medium">Pass Rate</p>
                    <p class="text-2xl font-bold text-green-600 mt-2" id="passRate">0%</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm font-medium">Checks Today</p>
                    <p class="text-2xl font-bold text-gray-900 mt-2" id="checksToday">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm font-medium">Failed Items</p>
                    <p class="text-2xl font-bold text-red-600 mt-2" id="failedItems">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm font-medium">Pending</p>
                    <p class="text-2xl font-bold text-orange-600 mt-2" id="pendingChecks">0</p>
                </div>
            </div>

            <div class="mb-6">
                <button onclick="showQCForm()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition">
                    <i class="fas fa-plus mr-2"></i>New QC Check
                </button>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Material</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Check Type</th>
                            <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Quantity</th>
                            <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Defects</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
                            <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="qcTableBody" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="qcModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Quality Check</h3>
                <form id="qcForm" onsubmit="submitQCCheck(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                            <input type="text" id="qcMaterial" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Check Type</label>
                            <select id="qcType" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Select Type</option>
                                <option value="visual">Visual</option>
                                <option value="dimensional">Dimensional</option>
                                <option value="tensile">Tensile</option>
                                <option value="color">Color</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                <input type="number" id="qcQuantity" min="1" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Defects</label>
                                <input type="number" id="qcDefects" min="0" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex gap-3 justify-end">
                        <button type="button" onclick="closeQCModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/assets/js/utils.js"></script>
    <script src="/modules/quality/script.js"></script>
    <script>
        let allQCChecks = [];

        async function loadQCChecks() {
            try {
                const response = await apiRequest('/api/v1/quality/checks');
                allQCChecks = response.data || [];
                displayQCChecks(allQCChecks);
                updateQCKPIs();
            } catch (error) {
                console.error('Error loading QC checks:', error);
                showNotification('Failed to load QC checks', 'error');
            }
        }

        function displayQCChecks(checks) {
            const tbody = document.getElementById('qcTableBody');
            tbody.innerHTML = checks.map(check => {
                const statusColors = {
                    'passed': 'bg-green-100 text-green-800',
                    'failed': 'bg-red-100 text-red-800',
                    'pending': 'bg-yellow-100 text-yellow-800'
                };
                const statusClass = statusColors[check.status] || 'bg-gray-100 text-gray-800';
                
                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 text-sm text-gray-900">${check.material_name || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${check.check_type || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-right">${check.quantity_checked || 0}</td>
                        <td class="px-6 py-4 text-sm text-right font-medium">${check.defects || 0}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                ${(check.status || 'pending').toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center text-sm">
                            <button onclick="deleteQCCheck('${check.check_id}')" class="text-red-600 hover:text-red-700">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateQCKPIs() {
            const passed = allQCChecks.filter(c => c.status === 'passed').length;
            const failed = allQCChecks.filter(c => c.status === 'failed').length;
            const pending = allQCChecks.filter(c => c.status === 'pending').length;
            const total = allQCChecks.length || 1;

            document.getElementById('passRate').textContent = ((passed / total) * 100).toFixed(1) + '%';
            document.getElementById('checksToday').textContent = passed;
            document.getElementById('failedItems').textContent = failed;
            document.getElementById('pendingChecks').textContent = pending;
        }

        function showQCForm() {
            document.getElementById('qcModal').classList.remove('hidden');
        }

        function closeQCModal() {
            document.getElementById('qcModal').classList.add('hidden');
        }

        async function submitQCCheck(event) {
            event.preventDefault();
            
            const defects = parseInt(document.getElementById('qcDefects').value);
            const quantity = parseInt(document.getElementById('qcQuantity').value);
            
            const formData = {
                material_name: document.getElementById('qcMaterial').value,
                check_type: document.getElementById('qcType').value,
                quantity_checked: quantity,
                defects: defects,
                status: defects === 0 ? 'passed' : 'failed'
            };

            try {
                await apiRequest('/api/v1/quality/checks', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                showNotification('QC check recorded', 'success');
                closeQCModal();
                document.getElementById('qcForm').reset();
                await loadQCChecks();
            } catch (error) {
                showNotification('Failed to record QC check', 'error');
            }
        }

        async function deleteQCCheck(checkId) {
            if (confirm('Delete this check?')) {
                try {
                    await apiRequest(`/api/v1/quality/checks/${checkId}`, { method: 'DELETE' });
                    showNotification('Check deleted', 'success');
                    await loadQCChecks();
                } catch (error) {
                    showNotification('Failed to delete check', 'error');
                }
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg text-white text-sm font-medium shadow-lg ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', loadQCChecks);
    </script>
</body>
</html>
