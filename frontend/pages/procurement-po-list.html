<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Orders - Textile ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/modules/procurement/styles.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 z-40 shadow-sm">
        <div class="flex items-center justify-between px-4 md:px-6 py-3">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-cyan-500 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold">TE</span>
                </div>
                <h1 class="text-lg md:text-xl font-bold text-gray-900">Textile ERP</h1>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/frontend/index.html" class="text-blue-600 hover:text-blue-700 font-medium">← Back to Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="pt-20 pb-8">
        <div class="max-w-7xl mx-auto px-4 md:px-6">
            <!-- Page Header -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Purchase Orders</h2>
                <p class="text-gray-600 mt-2">Manage and track all purchase orders</p>
            </div>

            <!-- Action Buttons -->
            <div class="mb-6 flex gap-3">
                <button onclick="showCreatePOForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">
                    <i class="fas fa-plus mr-2"></i>Create New PO
                </button>
                <button onclick="exportPOs()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
            </div>

            <!-- Filter Section -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="poSearch" placeholder="Search PO number..." class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="poStatus" class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="received">Received</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <input type="date" id="poDateFrom" class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="filterPOs()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">
                        <i class="fas fa-filter mr-2"></i>Filter
                    </button>
                </div>
            </div>

            <!-- Purchase Orders Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">PO Number</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Supplier</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Date</th>
                            <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Amount</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
                            <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="poTableBody" class="divide-y divide-gray-200">
                        <!-- Loaded via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create PO Modal -->
    <div id="createPOModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Create Purchase Order</h3>
                <form id="createPOForm" onsubmit="submitPO(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Supplier</label>
                            <select id="poSupplier" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">PO Date</label>
                                <input type="date" id="poDate" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                                <input type="date" id="poDueDate" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div id="poItems" class="space-y-2">
                            <div class="flex items-end gap-2">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                                    <input type="text" class="po-item-material w-full border border-gray-300 rounded px-3 py-2" required>
                                </div>
                                <div class="w-20">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Qty</label>
                                    <input type="number" class="po-item-qty w-full border border-gray-300 rounded px-3 py-2" min="1" required>
                                </div>
                                <div class="w-24">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                                    <input type="number" class="po-item-price w-full border border-gray-300 rounded px-3 py-2" min="0" step="0.01" required>
                                </div>
                                <button type="button" onclick="removePOItem(this)" class="bg-red-500 text-white px-2 py-2 rounded">×</button>
                            </div>
                        </div>
                        <button type="button" onclick="addPOItem()" class="text-blue-600 hover:text-blue-700 text-sm font-medium">+ Add Item</button>
                    </div>
                    <div class="mt-6 flex gap-3 justify-end">
                        <button type="button" onclick="closePOModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create PO</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/assets/js/utils.js"></script>
    <script src="/modules/procurement/script.js"></script>
    <script>
        let allPOs = [];

        // Load purchase orders
        async function loadPOs() {
            try {
                const response = await apiRequest('/api/v1/procurement/purchase-orders');
                allPOs = response.data || [];
                displayPOs(allPOs);
            } catch (error) {
                console.error('Error loading POs:', error);
                showNotification('Failed to load purchase orders', 'error');
            }
        }

        // Display POs in table
        function displayPOs(pos) {
            const tbody = document.getElementById('poTableBody');
            tbody.innerHTML = pos.map(po => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 text-sm font-medium text-blue-600">${po.po_number || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${po.supplier_name || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${po.order_date ? new Date(po.order_date).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-right font-medium">$${(po.total_amount || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 text-sm">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(po.status)}">
                            ${po.status?.toUpperCase() || 'PENDING'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center text-sm space-x-2">
                        <button onclick="viewPO('${po.po_id}')" class="text-blue-600 hover:text-blue-700">View</button>
                        <button onclick="editPO('${po.po_id}')" class="text-gray-600 hover:text-gray-700">Edit</button>
                        <button onclick="deletePO('${po.po_id}')" class="text-red-600 hover:text-red-700">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Get status badge class
        function getStatusClass(status) {
            const classes = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'confirmed': 'bg-blue-100 text-blue-800',
                'received': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // Show create PO form
        function showCreatePOForm() {
            document.getElementById('createPOModal').classList.remove('hidden');
            loadSuppliers();
        }

        // Close PO modal
        function closePOModal() {
            document.getElementById('createPOModal').classList.add('hidden');
        }

        // Add PO item row
        function addPOItem() {
            const html = `
                <div class="flex items-end gap-2">
                    <div class="flex-1">
                        <input type="text" class="po-item-material w-full border border-gray-300 rounded px-3 py-2" required>
                    </div>
                    <div class="w-20">
                        <input type="number" class="po-item-qty w-full border border-gray-300 rounded px-3 py-2" min="1" required>
                    </div>
                    <div class="w-24">
                        <input type="number" class="po-item-price w-full border border-gray-300 rounded px-3 py-2" min="0" step="0.01" required>
                    </div>
                    <button type="button" onclick="removePOItem(this)" class="bg-red-500 text-white px-2 py-2 rounded">×</button>
                </div>
            `;
            document.getElementById('poItems').insertAdjacentHTML('beforeend', html);
        }

        // Remove PO item
        function removePOItem(btn) {
            btn.parentElement.remove();
        }

        // Load suppliers
        async function loadSuppliers() {
            try {
                const response = await apiRequest('/api/v1/procurement/suppliers');
                const select = document.getElementById('poSupplier');
                select.innerHTML = '<option value="">Select Supplier</option>' +
                    (response.data || []).map(s => `<option value="${s.supplier_id}">${s.supplier_name}</option>`).join('');
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        }

        // Submit PO
        async function submitPO(event) {
            event.preventDefault();
            
            const items = Array.from(document.querySelectorAll('#poItems > div')).map(div => ({
                material_name: div.querySelector('.po-item-material').value,
                quantity: parseInt(div.querySelector('.po-item-qty').value),
                unit_price: parseFloat(div.querySelector('.po-item-price').value)
            }));

            const totalAmount = items.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);

            const formData = {
                supplier_id: document.getElementById('poSupplier').value,
                order_date: document.getElementById('poDate').value,
                due_date: document.getElementById('poDueDate').value,
                line_items: items,
                total_amount: totalAmount
            };

            try {
                await apiRequest('/api/v1/procurement/purchase-orders', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                showNotification('PO created successfully', 'success');
                closePOModal();
                await loadPOs();
            } catch (error) {
                console.error('Error creating PO:', error);
                showNotification('Failed to create PO', 'error');
            }
        }

        // Filter POs
        function filterPOs() {
            const search = document.getElementById('poSearch').value.toLowerCase();
            const status = document.getElementById('poStatus').value;
            
            const filtered = allPOs.filter(po => {
                const matchesSearch = (po.po_number || '').toLowerCase().includes(search);
                const matchesStatus = !status || po.status === status;
                return matchesSearch && matchesStatus;
            });
            
            displayPOs(filtered);
        }

        // View PO
        function viewPO(poId) {
            alert('View PO: ' + poId);
        }

        // Edit PO
        function editPO(poId) {
            alert('Edit PO: ' + poId);
        }

        // Delete PO
        async function deletePO(poId) {
            if (confirm('Are you sure you want to delete this PO?')) {
                try {
                    await apiRequest(`/api/v1/procurement/purchase-orders/${poId}`, { method: 'DELETE' });
                    showNotification('PO deleted successfully', 'success');
                    await loadPOs();
                } catch (error) {
                    console.error('Error deleting PO:', error);
                    showNotification('Failed to delete PO', 'error');
                }
            }
        }

        // Export POs
        function exportPOs() {
            let csv = 'PO Number,Supplier,Date,Amount,Status\n';
            allPOs.forEach(po => {
                csv += `${po.po_number},${po.supplier_name},${po.order_date},${po.total_amount},${po.status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'purchase_orders.csv';
            link.click();
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg text-white text-sm font-medium shadow-lg ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadPOs);
    </script>
</body>
</html>
