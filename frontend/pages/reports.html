<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Textile ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/modules/reports/styles.css">
</head>
<body class="bg-gray-50">
    <nav class="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 z-40 shadow-sm">
        <div class="flex items-center justify-between px-4 md:px-6 py-3">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-indigo-600 to-blue-500 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold">TE</span>
                </div>
                <h1 class="text-lg md:text-xl font-bold text-gray-900">Textile ERP</h1>
            </div>
            <a href="/frontend/index.html" class="text-blue-600 hover:text-blue-700 font-medium">← Back</a>
        </div>
    </nav>

    <div class="pt-20 pb-8">
        <div class="max-w-7xl mx-auto px-4 md:px-6">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900">Reports Dashboard</h2>
                <p class="text-gray-600 mt-2">Cross-module analytics and business intelligence</p>
            </div>

            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Report Type</label>
                        <select id="reportType" onchange="generateReport()" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="overview">Overview</option>
                            <option value="sales">Sales</option>
                            <option value="inventory">Inventory</option>
                            <option value="production">Production</option>
                            <option value="quality">Quality</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Period</label>
                        <select id="reportPeriod" onchange="generateReport()" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                        <input type="date" id="reportDate" onchange="generateReport()" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex gap-2 items-end">
                        <button onclick="exportReportPDF()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition">
                            <i class="fas fa-file-pdf mr-2"></i>PDF
                        </button>
                        <button onclick="exportReportExcel()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition">
                            <i class="fas fa-file-excel mr-2"></i>Excel
                        </button>
                    </div>
                </div>
            </div>

            <div id="reportMetrics" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm font-medium">Total Revenue</p>
                    <p class="text-2xl font-bold text-indigo-600 mt-2" id="metricRevenue">$0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm font-medium">Inventory Value</p>
                    <p class="text-2xl font-bold text-blue-600 mt-2" id="metricInventory">$0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm font-medium">Production Yield</p>
                    <p class="text-2xl font-bold text-green-600 mt-2" id="metricYield">0%</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm font-medium">Quality Rate</p>
                    <p class="text-2xl font-bold text-purple-600 mt-2" id="metricQuality">0%</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Sales by Customer</h3>
                    <div id="salesByCustomer" class="space-y-3">
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-gray-600">Loading...</span>
                            <span class="text-gray-600">$0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Inventory Status</h3>
                    <div id="inventoryStatus" class="space-y-3">
                        <div class="flex justify-between items-center pb-2 border-b">
                            <span class="text-gray-600">Materials</span>
                            <span class="text-gray-600">0 units</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Production Efficiency</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-700 font-medium">Line 1 Efficiency</span>
                            <span class="text-indigo-600 font-bold">92%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: 92%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-700 font-medium">Line 2 Efficiency</span>
                            <span class="text-blue-600 font-bold">87%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: 87%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-700 font-medium">Overall Efficiency</span>
                            <span class="text-green-600 font-bold">89.5%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: 89.5%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-900">Detailed Report</h3>
                </div>
                <table class="w-full">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Module</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Metric</th>
                            <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Current</th>
                            <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Previous</th>
                            <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700">Change</th>
                        </tr>
                    </thead>
                    <tbody id="detailedReportBody" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/assets/js/utils.js"></script>
    <script src="/modules/reports/script.js"></script>
    <script>
        let reportData = {};

        async function loadReportData() {
            try {
                const endpoints = [
                    '/api/v1/sales/orders',
                    '/api/v1/inventory/materials',
                    '/api/v1/production/work-orders',
                    '/api/v1/quality/checks',
                    '/api/v1/procurement/purchase-orders'
                ];

                const results = await Promise.all(
                    endpoints.map(ep => apiRequest(ep).catch(() => ({ data: [] })))
                );

                reportData = {
                    sales: results[0].data || [],
                    inventory: results[1].data || [],
                    production: results[2].data || [],
                    quality: results[3].data || [],
                    procurement: results[4].data || []
                };

                generateReport();
            } catch (error) {
                console.error('Error loading report data:', error);
            }
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            updateMetrics();
            displaySalesByCustomer();
            displayInventoryStatus();
            displayDetailedReport();
        }

        function updateMetrics() {
            const totalRevenue = reportData.sales?.reduce((sum, s) => sum + (s.total_amount || 0), 0) || 0;
            const inventoryValue = reportData.inventory?.reduce((sum, m) => sum + ((m.quantity || 0) * (m.unit_cost || 0)), 0) || 0;
            const completed = reportData.production?.filter(p => p.status === 'completed').length || 0;
            const total = reportData.production?.length || 1;
            const passed = reportData.quality?.filter(q => q.status === 'passed').length || 0;
            const totalQC = reportData.quality?.length || 1;

            document.getElementById('metricRevenue').textContent = '$' + (totalRevenue / 1000).toFixed(1) + 'K';
            document.getElementById('metricInventory').textContent = '$' + (inventoryValue / 1000).toFixed(1) + 'K';
            document.getElementById('metricYield').textContent = ((completed / total) * 100).toFixed(1) + '%';
            document.getElementById('metricQuality').textContent = ((passed / totalQC) * 100).toFixed(1) + '%';
        }

        function displaySalesByCustomer() {
            const container = document.getElementById('salesByCustomer');
            const salesByCustomer = {};
            
            reportData.sales?.forEach(sale => {
                const customer = sale.customer_name || 'Unknown';
                salesByCustomer[customer] = (salesByCustomer[customer] || 0) + (sale.total_amount || 0);
            });

            container.innerHTML = Object.entries(salesByCustomer)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([customer, amount]) => `
                    <div class="flex justify-between items-center pb-2 border-b">
                        <span class="text-gray-700">${customer}</span>
                        <span class="font-medium text-indigo-600">$${amount.toFixed(2)}</span>
                    </div>
                `).join('');
        }

        function displayInventoryStatus() {
            const container = document.getElementById('inventoryStatus');
            const totalQty = reportData.inventory?.reduce((sum, m) => sum + (m.quantity || 0), 0) || 0;
            const lowStock = reportData.inventory?.filter(m => (m.quantity || 0) <= (m.reorder_level || 0)).length || 0;

            container.innerHTML = `
                <div class="flex justify-between items-center pb-2 border-b">
                    <span class="text-gray-700">Total Materials</span>
                    <span class="font-medium text-blue-600">${reportData.inventory?.length || 0}</span>
                </div>
                <div class="flex justify-between items-center pb-2 border-b">
                    <span class="text-gray-700">Total Quantity</span>
                    <span class="font-medium text-blue-600">${totalQty.toLocaleString()} units</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Low Stock</span>
                    <span class="font-medium text-red-600">${lowStock} items</span>
                </div>
            `;
        }

        function displayDetailedReport() {
            const container = document.getElementById('detailedReportBody');
            
            const metrics = [
                { module: 'Sales', metric: 'Total Orders', current: reportData.sales?.length || 0, previous: Math.max(0, (reportData.sales?.length || 1) - 2) },
                { module: 'Sales', metric: 'Total Revenue', current: '€' + (reportData.sales?.reduce((s, o) => s + (o.total_amount || 0), 0) || 0).toFixed(0), previous: 'N/A' },
                { module: 'Inventory', metric: 'Materials', current: reportData.inventory?.length || 0, previous: Math.max(0, (reportData.inventory?.length || 1) - 1) },
                { module: 'Production', metric: 'Work Orders', current: reportData.production?.length || 0, previous: Math.max(0, (reportData.production?.length || 1) - 1) },
                { module: 'Quality', metric: 'QC Checks', current: reportData.quality?.length || 0, previous: Math.max(0, (reportData.quality?.length || 1) - 2) }
            ];

            container.innerHTML = metrics.map(m => {
                const currentVal = typeof m.current === 'number' ? m.current : m.current;
                const previousVal = typeof m.previous === 'number' ? m.previous : m.previous;
                const change = typeof m.current === 'number' && typeof m.previous === 'number' 
                    ? ((m.current - m.previous) / Math.max(m.previous, 1)) * 100
                    : 0;
                const changeColor = change >= 0 ? 'text-green-600' : 'text-red-600';
                const changeSymbol = change >= 0 ? '+' : '';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-700">${m.module}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${m.metric}</td>
                        <td class="px-6 py-4 text-sm text-right font-medium">${currentVal}</td>
                        <td class="px-6 py-4 text-sm text-right text-gray-600">${previousVal}</td>
                        <td class="px-6 py-4 text-sm text-center font-medium ${changeColor}">${changeSymbol}${change.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');
        }

        function exportReportPDF() {
            window.print();
            showNotification('Report exported to PDF', 'success');
        }

        function exportReportExcel() {
            const reportType = document.getElementById('reportType').value;
            const data = JSON.stringify(reportData, null, 2);
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `report_${reportType}_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            showNotification('Report exported to file', 'success');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg text-white text-sm font-medium shadow-lg ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            loadReportData();
        });
    </script>
</body>
</html>
