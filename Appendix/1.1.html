<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Textile ERP | ML Intelligence Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --primary-smart: #10b981;
            --secondary-data: #3b82f6;
            --accent-ml: #f59e0b;
            --risk-high: #ef4444;
            --risk-low: #10b981;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        .nav-link.active-link {
            background-color: var(--primary-smart); 
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1), 0 2px 4px -2px rgba(16, 185, 129, 0.1);
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: #4b5563;
            transition: all 150ms ease-in-out;
        }
        
        .nav-link:hover:not(.active-link) {
            background-color: #f3f4f6;
            color: var(--primary-smart);
        }
        
        .module-content {
            display: none;
        }
        
        .dashboard-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            transition: transform 0.2s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .ml-card-icon {
            font-size: 24px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-completed {
            background-color: #e8f6ef;
            color: var(--risk-low);
        }
        
        .status-processing {
            background-color: #e8f4fd;
            color: var(--secondary-data);
        }
        
        .status-pending {
            background-color: #fef9e7;
            color: var(--accent-ml);
        }
        
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                z-index: 40;
                height: 100%;
            }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Mobile Sidebar Toggle -->
    <button id="sidebarToggle" class="fixed top-4 left-4 z-50 p-3 rounded-full bg-primary-smart text-white lg:hidden shadow-lg">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar transform -translate-x-full lg:translate-x-0 w-64 bg-white border-r border-gray-200 shadow-xl fixed lg:relative flex flex-col h-full">
        <div class="p-6 border-b border-gray-100 flex items-center space-x-3 h-[70px]">
            <i class="fas fa-industry w-8 h-8 text-primary-smart text-2xl"></i>
            <span class="text-xl font-extrabold text-gray-800">Tex-Smart ERP</span>
        </div>
        
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <div class="text-xs font-semibold uppercase text-gray-400 px-3 pt-3 pb-1">Intelligent Hub</div>
            <a href="#" data-module="ml_hub" class="nav-link active-link">
                <i class="fas fa-brain w-5 h-5"></i>
                <span>ML Intelligence Hub</span>
                <span class="ml-auto text-xs font-bold bg-white text-primary-smart px-2 py-0.5 rounded-full">AI</span>
            </a>
            
            <div class="text-xs font-semibold uppercase text-gray-400 px-3 pt-6 pb-1">Core Modules</div>
            <a href="#" data-module="erp_overview" class="nav-link">
                <i class="fas fa-tachometer-alt w-5 h-5"></i>
                <span>ERP Overview</span>
            </a>
            <a href="#" data-module="procurement" class="nav-link">
                <i class="fas fa-handshake w-5 h-5"></i>
                <span>Procurement & Suppliers</span>
            </a>
            <a href="#" data-module="inventory" class="nav-link">
                <i class="fas fa-warehouse w-5 h-5"></i>
                <span>Inventory & Optimization</span>
            </a>
            <a href="#" data-module="production" class="nav-link">
                <i class="fas fa-cogs w-5 h-5"></i>
                <span>Production & BOM</span>
            </a>
            <a href="#" data-module="qc" class="nav-link">
                <i class="fas fa-check-circle w-5 h-5"></i>
                <span>Quality Control</span>
            </a>
            <a href="#" data-module="sales" class="nav-link">
                <i class="fas fa-shopping-cart w-5 h-5"></i>
                <span>Sales & Orders</span>
            </a>
        </nav>
        
        <div class="p-4 border-t border-gray-100">
            <a href="#" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-100 transition duration-150">
                <img class="h-10 w-10 rounded-full object-cover border-2 border-primary-smart" src="https://i.pravatar.cc/150?img=12" alt="User Profile">
                <div class="text-sm">
                    <p class="font-medium text-gray-800">Admin User</p>
                    <p class="text-xs text-green-600" id="auth-status">Authenticated</p>
                </div>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-30 h-[70px]">
            <h1 class="text-2xl font-semibold text-gray-800 hidden md:block" id="page-title">ML Intelligence Hub</h1>
            <div class="flex items-center space-x-4">
                <div class="relative hidden sm:block">
                    <input type="text" placeholder="Search modules, reports, or data..." class="py-2 pl-10 pr-4 border border-gray-300 rounded-lg focus:ring-primary-smart focus:border-primary-smart transition w-64" />
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <button class="relative text-gray-500 hover:text-primary-smart p-2 rounded-full bg-gray-100 transition duration-150">
                    <i class="fas fa-bell w-5 h-5"></i>
                    <span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-risk-high rounded-full">3</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-8 space-y-8">
            <!-- ML Intelligence Hub -->
            <section id="ml_hub_content" class="module-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">ML Intelligence Hub üß†</h2>
                
                <!-- ML Summary Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="ml-summary-cards">
                    <div class="dashboard-card border-b-4 border-primary-smart">
                        <p class="text-sm font-medium text-gray-500">Demand Forecast Accuracy</p>
                        <p class="text-4xl font-extrabold text-primary-smart mt-2" id="df-accuracy">--</p>
                        <p class="text-xs text-gray-600 mt-2" id="df-model-info">Fetching...</p>
                    </div>
                    <div class="dashboard-card border-b-4 border-accent-ml">
                        <p class="text-sm font-medium text-gray-500">Inventory Optimization Score</p>
                        <p class="text-4xl font-extrabold text-accent-ml mt-2" id="io-score">--</p>
                        <p class="text-xs text-gray-600 mt-2" id="io-model-info">Fetching...</p>
                    </div>
                    <div class="dashboard-card border-b-4 border-risk-high">
                        <p class="text-sm font-medium text-gray-500">Predicted Supplier Risk</p>
                        <p class="text-4xl font-extrabold text-risk-high mt-2" id="sr-risk">--</p>
                        <p class="text-xs text-gray-600 mt-2" id="sr-model-info">Fetching...</p>
                    </div>
                    <div class="dashboard-card border-b-4 border-secondary-data">
                        <p class="text-sm font-medium text-gray-500">Automated Defect Rate</p>
                        <p class="text-4xl font-extrabold text-secondary-data mt-2" id="qc-defect-rate">--</p>
                        <p class="text-xs text-gray-600 mt-2" id="qc-model-info">Fetching...</p>
                    </div>
                </div>

                <!-- Charts and Optimization -->
                <div class="lg:grid lg:grid-cols-3 gap-8 mb-8">
                    <div class="lg:col-span-2 dashboard-card p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Demand Forecast (SKU: CFF234)</h3>
                        <div class="h-80 bg-gray-50 p-4 rounded-lg flex items-center justify-center border border-dashed border-gray-300 mb-4">
                            <canvas id="demandForecastChart"></canvas>
                        </div>
                        <div class="p-4 bg-blue-50 border-l-4 border-secondary-data rounded-lg">
                            <p class="text-sm font-medium text-secondary-data mb-1">Dynamic API Insight (Action Required):</p>
                            <p class="text-base text-gray-700 font-semibold" id="dynamic-insight">Fetching actionable insight...</p>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-1 dashboard-card p-6 mt-8 lg:mt-0">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Inventory Optimization</h3>
                        <p class="text-sm text-gray-500 mb-4">Top 3 RF recommendations:</p>
                        <ul id="inventory-list" class="space-y-3">
                            <li class="p-3 bg-yellow-50 rounded-lg">Loading items...</li>
                        </ul>
                        <button onclick="fetchInventoryOptimization(true)" class="w-full mt-6 bg-accent-ml text-white p-3 rounded-xl font-medium hover:bg-amber-600 transition duration-150 shadow-md">
                            Run Optimization & View Full Report
                        </button>
                    </div>
                </div>

                <!-- ML Model Overview -->
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">ML Model Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="dashboard-card flex flex-col items-center">
                        <div class="ml-card-icon" style="background: #3b82f6;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="text-lg font-semibold mb-2">Demand Forecasting</div>
                        <div class="text-sm text-gray-500 mb-4">LSTM-based model for predicting future demand patterns.</div>
                        <button class="w-full bg-secondary-data text-white p-2 rounded-lg font-medium hover:bg-blue-600 transition">View Forecast</button>
                    </div>

                    <div class="dashboard-card flex flex-col items-center">
                        <div class="ml-card-icon" style="background: #10b981;">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="text-lg font-semibold mb-2">Inventory Optimization</div>
                        <div class="text-sm text-gray-500 mb-4">Random Forest Regression for optimal stock levels.</div>
                        <button class="w-full bg-primary-smart text-white p-2 rounded-lg font-medium hover:bg-emerald-600 transition">Optimize Now</button>
                    </div>

                    <div class="dashboard-card flex flex-col items-center">
                        <div class="ml-card-icon" style="background: #ef4444;">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="text-lg font-semibold mb-2">Defect Detection</div>
                        <div class="text-sm text-gray-500 mb-4">CNN/Logistic Regression for automated defect classification.</div>
                        <button onclick="showDefectData()" class="w-full bg-risk-high text-white p-2 rounded-lg font-medium hover:bg-red-600 transition">Analyze Quality</button>
                    </div>

                    <div class="dashboard-card flex flex-col items-center">
                        <div class="ml-card-icon" style="background: #f59e0b;">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="text-lg font-semibold mb-2">Supplier Scoring</div>
                        <div class="text-sm text-gray-500 mb-4">SVM for supplier performance prediction and evaluation.</div>
                        <button onclick="fetchSupplierRisk()" class="w-full bg-accent-ml text-white p-2 rounded-lg font-medium hover:bg-amber-600 transition">Score Suppliers</button>
                    </div>
                </div>
            </section>

            <!-- ERP Overview -->
            <section id="erp_overview_content" class="module-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">ERP Overview üìä</h2>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="dashboard-card border-l-4 border-secondary-data">
                        <p class="text-sm font-medium text-gray-500">Active Work Orders</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">1,248</p>
                        <p class="text-xs text-green-600 mt-2"><i class="fas fa-arrow-up"></i> 12% from last month</p>
                    </div>
                    <div class="dashboard-card border-l-4 border-primary-smart">
                        <p class="text-sm font-medium text-gray-500">Current Stock Value</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">$2.84M</p>
                        <p class="text-xs text-red-600 mt-2"><i class="fas fa-arrow-down"></i> 5% from last month</p>
                    </div>
                    <div class="dashboard-card border-l-4 border-risk-high">
                        <p class="text-sm font-medium text-gray-500">Quality Defect Rate</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">2.4%</p>
                        <p class="text-xs text-red-600 mt-2"><i class="fas fa-arrow-up"></i> 0.3% from last month</p>
                    </div>
                    <div class="dashboard-card border-l-4 border-accent-ml">
                        <p class="text-sm font-medium text-gray-500">Open Sales Orders</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">34</p>
                        <p class="text-xs text-gray-600 mt-2">Avg. $75k per order</p>
                    </div>
                </div>

                <!-- Production Orders Table -->
                <div class="dashboard-card p-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-xl font-semibold text-gray-800">Recent Production Orders</h3>
                        <select class="p-2 border border-gray-300 rounded-lg text-sm">
                            <option>All Status</option>
                            <option>Completed</option>
                            <option>Processing</option>
                            <option>Pending</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#PO-4821</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">Cotton T-Shirt</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">5,000 units</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">Nov 15, 2023</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge status-completed">Completed</span>
                                    </td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#PO-4822</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">Denim Jeans</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">2,500 units</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">Nov 20, 2023</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge status-processing">Processing</span>
                                    </td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#PO-4823</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">Polyester Jacket</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">1,200 units</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">Nov 25, 2023</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge status-pending">Pending</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Procurement & Suppliers -->
            <section id="procurement_content" class="module-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Procurement & Suppliers ü§ù</h2>
                <div class="p-8 dashboard-card border-l-4 border-indigo-500">
                    <p class="text-xl font-medium text-indigo-700 mb-4">Purchase Order (PO) Management & Risk</p>
                    <p class="text-gray-600">Manage supplier lifecycle, PO creation, and goods receipt. The ML Supplier Scoring model (SVM) is integrated here to flag high-risk suppliers before order placement.</p>
                    <p class="mt-4 text-sm text-gray-600 font-semibold">API Endpoint Example: POST /api/procurement/new_po</p>
                    <button class="mt-4 bg-indigo-500 text-white p-2 rounded-lg text-sm hover:bg-indigo-600 transition">Create New PO</button>
                </div>
            </section>

            <!-- Inventory & Optimization -->
            <section id="inventory_content" class="module-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Inventory & Traceability üì¶</h2>
                <div class="p-8 dashboard-card border-l-4 border-yellow-500">
                    <p class="text-xl font-medium text-yellow-700 mb-4">Raw Material Stock and Batch Traceability</p>
                    <p class="text-gray-600">View real-time inventory levels, stock lot tracking, and warehouse locations. The **Random Forest Inventory Optimization** runs directly off this module's data, recommending optimal reorder points and quantities.</p>
                    <p class="mt-4 text-sm text-gray-600 font-semibold">API Endpoint Example: GET /api/inventory/stock_level?sku=RC-S1</p>
                    <button class="mt-4 bg-yellow-500 text-white p-2 rounded-lg text-sm hover:bg-yellow-600 transition">View Stock Lots</button>
                </div>
            </section>

            <!-- Production & BOM -->
            <section id="production_content" class="module-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Production & BOM ‚öôÔ∏è</h2>
                <div class="p-8 dashboard-card border-l-4 border-blue-500">
                    <p class="text-xl font-medium text-blue-700 mb-4">Work Order and Bill-of-Materials (BOM) Tracking</p>
                    <p class="text-gray-600">Manages production schedules, tracks work-in-progress (WIP), and defines product BOMs. Production targets are dynamically updated based on the **LSTM Demand Forecast** results.</p>
                    <p class="mt-4 text-sm text-gray-600 font-semibold">API Endpoint Example: PUT /api/production/update_status?wo_id=WO-045</p>
                    <button class="mt-4 bg-blue-500 text-white p-2 rounded-lg text-sm hover:bg-blue-600 transition">View Production Schedule</button>
                </div>
            </section>

            <!-- Quality Control -->
            <section id="qc_content" class="module-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Quality Control ‚úÖ</h2>
                <div class="p-8 dashboard-card border-l-4 border-risk-high">
                    <p class="text-xl font-medium text-risk-high mb-4">Defect Logging and Automated Classification</p>
                    <p class="text-gray-600">Interface for logging defects, viewing images from the line, and consuming real-time classification results from the **CNN/Logistic Regression Defect Detection** ML model.</p>
                    <p class="mt-4 text-sm text-gray-600 font-semibold">API Endpoint Example: POST /api/qc/log_defect</p>
                    <button class="mt-4 bg-risk-high text-white p-2 rounded-lg text-sm hover:bg-red-600 transition">Log New Defect</button>
                </div>
            </section>

            <!-- Sales & Orders -->
            <section id="sales_content" class="module-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Sales & Orders üí∞</h2>
                <div class="p-8 dashboard-card border-l-4 border-fuchsia-500">
                    <p class="text-xl font-medium text-fuchsia-700 mb-4">Order Management and Customer Feedback</p>
                    <p class="text-gray-600">Tracks customer orders and fulfillment rates. It heavily relies on the **Demand Forecasting ML** results to set sales quotas and prioritize high-demand product fulfillment.</p>
                    <p class="mt-4 text-sm text-gray-600 font-semibold">API Endpoint Example: GET /api/sales/customer_orders?status=pending</p>
                    <button class="mt-4 bg-fuchsia-500 text-white p-2 rounded-lg text-sm hover:bg-fuchsia-600 transition">Manage Sales Orders</button>
                </div>
            </section>
        </main>
    </div>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'http://127.0.0.1:5000/api/ml'; // Flask API base URL
        
        // Module Navigation
        const moduleMap = {
            'ml_hub': { title: 'ML Intelligence Hub', contentId: 'ml_hub_content' },
            'erp_overview': { title: 'ERP Overview', contentId: 'erp_overview_content' },
            'procurement': { title: 'Procurement & Suppliers', contentId: 'procurement_content' },
            'inventory': { title: 'Inventory & Optimization', contentId: 'inventory_content' },
            'production': { title: 'Production & BOM', contentId: 'production_content' },
            'qc': { title: 'Quality Control', contentId: 'qc_content' },
            'sales': { title: 'Sales & Orders', contentId: 'sales_content' }
        };
        
        const pageTitle = document.getElementById('page-title');
        const contentSections = document.querySelectorAll('.module-content');
        const navLinks = document.querySelectorAll('.nav-link');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        let demandChart;

        // Initialize the application
        function initApp() {
            setupNavigation();
            setupSidebarToggle();
            switchModule('ml_hub');
            fetchAllMLData();
        }

        // Navigation Setup
        function setupNavigation() {
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const moduleId = e.currentTarget.getAttribute('data-module');
                    if (moduleId) switchModule(moduleId);
                });
            });
        }

        // Sidebar Toggle for Mobile
        function setupSidebarToggle() {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });
            
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                    sidebar.classList.remove('-translate-x-full');
                }
            });
        }

        // Module Switching
        function switchModule(moduleId) {
            // Update navigation
            navLinks.forEach(link => link.classList.remove('active-link'));
            const activeLink = document.querySelector(`[data-module="${moduleId}"]`);
            if (activeLink) activeLink.classList.add('active-link');

            // Update content
            contentSections.forEach(section => section.style.display = 'none');
            const moduleInfo = moduleMap[moduleId];
            if (moduleInfo) {
                const activeContent = document.getElementById(moduleInfo.contentId);
                if (activeContent) activeContent.style.display = 'block';
                pageTitle.textContent = moduleInfo.title;
            }

            // Close sidebar on mobile after selection
            if (window.innerWidth < 1024) sidebar.classList.add('-translate-x-full');

            // Trigger data fetch for ML Hub
            if (moduleId === 'ml_hub') {
                fetchAllMLData();
            }
        }

        // ML Data Fetching Functions
        async function fetchMLSummaryCards() {
            try {
                // Mock data for demonstration - replace with actual API calls
                document.getElementById('df-accuracy').textContent = '94.2%';
                document.getElementById('df-model-info').textContent = 'Model: LSTM (Upward trend)';
                
                document.getElementById('io-score').textContent = 'B+';
                document.getElementById('io-model-info').textContent = 'RF Regression Metric';
                
                document.getElementById('sr-risk').textContent = '12% High';
                document.getElementById('sr-model-info').textContent = 'Model: SVM (Score: 0.88)';
                
                document.getElementById('qc-defect-rate').textContent = '2.1%';
                document.getElementById('qc-model-info').textContent = 'Model Confidence: 96.5%';
            } catch (error) {
                console.error("Error fetching ML summary data:", error);
                document.getElementById('df-accuracy').textContent = 'API Error';
            }
        }

        async function fetchMLDemandForecast() {
            const insightElement = document.getElementById('dynamic-insight');
            
            try {
                // Mock API response
                const mockData = {
                    insight: "Demand for SKU CFF234 is projected to increase by 18% next quarter. Consider increasing production capacity.",
                    timestamp: new Date().toLocaleDateString()
                };
                
                insightElement.innerHTML = `‚ö†Ô∏è ${mockData.insight} (Last Update: ${mockData.timestamp})`;
            } catch (error) {
                insightElement.textContent = `Error: Could not connect to Flask API at ${API_BASE_URL}/demand_forecast. Is the server running?`;
                console.error(error);
            }
        }

        async function fetchInventoryOptimization(showAlert = false) {
            const inventoryList = document.getElementById('inventory-list');
            
            try {
                // Mock data for demonstration
                const mockData = [
                    { sku: 'COT-001', action: 'Reorder 500 units', status: 'CRITICAL LOW' },
                    { sku: 'POL-023', action: 'Reduce stock by 20%', status: 'OVERSTOCK' },
                    { sku: 'DEN-045', action: 'Maintain current levels', status: 'OPTIMAL' }
                ];
                
                inventoryList.innerHTML = mockData.map(item => {
                    let badgeClass, statusColor;
                    if (item.status === 'CRITICAL LOW') {
                        badgeClass = 'bg-risk-high/10 text-risk-high';
                        statusColor = 'bg-red-50';
                    } else if (item.status === 'OVERSTOCK') {
                        badgeClass = 'bg-accent-ml/10 text-accent-ml';
                        statusColor = 'bg-yellow-50';
                    } else {
                        badgeClass = 'bg-primary-smart/10 text-primary-smart';
                        statusColor = 'bg-green-50';
                    }

                    return `
                        <li class="p-3 ${statusColor} rounded-lg flex justify-between items-center border border-gray-100">
                            <div>
                                <p class="font-medium text-gray-800">${item.sku}</p>
                                <p class="text-xs text-gray-500">RF Suggests: ${item.action}</p>
                            </div>
                            <span class="text-sm font-semibold px-3 py-1 rounded-full ${badgeClass}">${item.status}</span>
                        </li>
                    `;
                }).join('');

                if (showAlert) {
                    alert('Inventory Optimization Run Complete! See top 3 recommendations.');
                }
            } catch (error) {
                inventoryList.innerHTML = `<li class="p-3 bg-red-100 rounded-lg text-red-600">Error fetching inventory data.</li>`;
                console.error("Error fetching inventory optimization:", error);
            }
        }

        async function fetchSupplierRisk() {
            try {
                // Mock API response
                const mockData = {
                    supplier_id: 'SUP-045',
                    risk_score: 0.88,
                    risk_level: 'HIGH',
                    recommendation: 'Consider diversifying suppliers for this material.'
                };

                alert(`Supplier ${mockData.supplier_id} Risk Score: ${mockData.risk_score} (${mockData.risk_level})\n\nRecommendation: ${mockData.recommendation}`);
            } catch (error) {
                alert('Error fetching supplier risk data.');
                console.error("Error fetching supplier risk:", error);
            }
        }

        async function showDefectData() {
            try {
                // Mock API response
                const mockData = {
                    total_defects: 42,
                    defect_rate: '2.1%',
                    model_confidence: '96.5%',
                    classifications: {
                        'Color Mismatch': 15,
                        'Fabric Tear': 8,
                        'Stitching Error': 12,
                        'Print Defect': 7
                    }
                };
                
                let defectAlert = `Quality Control Summary:\n\nTotal Defects Found: ${mockData.total_defects}\nDefect Rate: ${mockData.defect_rate}\nModel Confidence: ${mockData.model_confidence}\n\nClassification Breakdown:\n`;
                for (const [key, value] of Object.entries(mockData.classifications)) {
                    defectAlert += `- ${key}: ${value} instances\n`;
                }
                
                alert(defectAlert);
            } catch (error) {
                alert('Error fetching defect classification data.');
                console.error("Error fetching defect classification:", error);
            }
        }

        function fetchAllMLData() {
            fetchMLSummaryCards();
            fetchMLDemandForecast();
            fetchInventoryOptimization();
            renderDemandForecastChart();
        }

        // Chart.js Rendering
        function renderDemandForecastChart() {
            if (demandChart) {
                demandChart.destroy();
            }
            
            const ctx = document.getElementById('demandForecastChart').getContext('2d');
            const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov (F)', 'Dec (F)'];
            const actualData = [120, 150, 130, 180, 210, 240, 200, 230, 250, 280, null, null];
            const forecastData = [null, null, null, null, null, null, null, null, null, 280, 340, 380];
            
            demandChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Actual Sales (Units)',
                            data: actualData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 5,
                            pointBackgroundColor: '#3b82f6',
                            spanGaps: true
                        },
                        {
                            label: 'ML Forecast',
                            data: forecastData,
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 5,
                            pointBackgroundColor: '#f59e0b',
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Units Sold (x100)'
                            }
                        }
                    }
                }
            });
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>